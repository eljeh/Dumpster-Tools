---
import NotesDialog from './NotesDialog.astro';
---

<form class='w-full flex flex-col row item-center'>
	<!--  IG Players -->
	<div class='playerIDSelect-container'>
		<label class='block font-bold mb-2' for='playerIDSelect'>
			In Game Players
		</label>

		<div class='flex'>
			<select id='playerIDSelect'>
				<option value=''>...loading data</option>
			</select>
		</div>
	</div>
	<!-- playerIDgp -->
	<div class='playerIDgp-container'>
		<label class='block font-bold mb-2' for='playerIDgp'>
			Player Id (Discord/Steam)
		</label>
		<input
			type='text'
			id='playerIDgp'
			name='playerIDgp'
			required
			class='border rounded mb-2'
		/>
	</div>

	<button id='getPlayerButton'> Get Player Info </button>
</form>

<div class='playerInfoWrapper'>
	<div id='playerInfo'></div>
	<div id='squadInfo'></div>
	<div id='squadCounts'>
		<span id='memberCount'></span>
		<span id='flagCount'></span>
		<span id='vehicleCount'></span>
	</div>
	<div id='details'></div>
</div>

<NotesDialog />

<script>
	document.addEventListener('astro:page-load', () => {
		// Get the order button element
		const getPlayerButton = document.getElementById('getPlayerButton');

		const playerInfo = document.getElementById('playerInfo');
		const squadInfo = document.getElementById('squadInfo');
		const squadCounts = document.getElementById('squadCounts');
		const details = document.getElementById('details');

		const notesDialog = document.getElementById('notesDialog');

		const memberCount = document.getElementById('memberCount');
		const flagCount = document.getElementById('flagCount');
		const vehicleCount = document.getElementById('vehicleCount');

		async function populatePlayerSelect() {
			try {
				const url = 'https://api.whalleybot.com/bot/217fc652/PlayerLocations';
				const response = await fetch(url, {
					method: 'GET',
					headers: {
						Accept: '*/*',
						Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
					},
				});
				
				// Add explicit check for 403
				if (response.status === 403) {
					throw new Error('Authorization failed - please check your API key');
				}
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				const playerData = await response.json();

				const playerSelect = document.getElementById('playerIDSelect');
				playerSelect.innerHTML = '<option value="">Select a player</option>';

				playerData.sort((a, b) => a.playerName.localeCompare(b.playerName));
				playerData.forEach((player) => {
					const option = new Option(player.playerName, player.steamID);
					playerSelect.appendChild(option);
				});
			} catch (error) {
				console.error('Error populating player select:', error);
				const playerSelect = document.getElementById('playerIDSelect');
				playerSelect.innerHTML = '<option value="">Error loading players</option>';
			}
		}

		populatePlayerSelect();

		// Add event listener to handle button click
		getPlayerButton.addEventListener('click', async (event) => {
			event.preventDefault();
			const playerInfoWrapper = document.querySelector('.playerInfoWrapper');
			playerInfoWrapper.classList.add('panel');
			playerInfo.innerHTML = ``;
			squadInfo.innerHTML = ``;
			details.innerHTML = ``;

			const selectedPlayer = document.getElementById('playerIDSelect');
			// Get the selected player and pack elements
			const playerID = document.getElementById('playerIDgp');
			// if playerID is empty, use the selected player
			if (!playerID.value) {
				playerID.value = selectedPlayer.value;
			}

			if (playerID.value) {
				try {
					// Send a POST request to order the pack
					const response = await fetch(
						`https://api.whalleybot.com/bot/217fc652/GetPlayer/${playerID.value}/`,
						{
							method: 'GET',
							headers: {
								Accept: '*/*',
								Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
							},
						},
					);

					// Add explicit check for 403
					if (response.status === 403) {
						throw new Error('Authorization failed - please check your API key');
					}
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					playerInfo.innerHTML = `Getting info for ${playerID.value}`;

					// Parse the response data
					const data = await response.json();
					playerInfo.innerHTML = `<button id='notes-${data.Player.SteamID}' class='notesButton'><i class="fi fi-ss-notebook"></i><span>Notes</span></button>`;
					playerInfo.innerHTML += `<h3>${data.Player.PlayerName}</h3>`;
					playerInfo.innerHTML += `Discord ID: ${data.Player.DiscordID}`;
					playerInfo.innerHTML += `<br>Steam ID: ${data.Player.SteamID}`;
					playerInfo.innerHTML += `<br>IP Address: ${data.Player.IP}`;
					playerInfo.innerHTML += `<br>`;
					playerInfo.innerHTML += `<br>Account: ${data.Player.AccountNumber}`;
					playerInfo.innerHTML += `<br>ü™ô ${data.Player.Coins.toLocaleString()} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üíµ  ${data.Player.CreditBalance.toLocaleString()} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üí∞  ${data.Player.GoldBalance.toLocaleString()}`;

					const notesButton = document.getElementsByClassName('notesButton')[0];
					notesDialog.setAttribute('data-player-id', data.Player.SteamID);
					const notesForm = document.getElementById('notesForm');
					notesForm.setAttribute('data-player-id', data.Player.SteamID);
					const notesTitle = document.getElementById('noteTitle');

					notesTitle.innerHTML = `Notes - ${data.Player.PlayerName} <small>(${playerID.value})</small>`;

					// fuction that gets the notes from the playerNotes.json file
					async function getNotes(playerID) {
						const response = await fetch(`data/playerNotes.json`);
						const dataN = await response.json();
						const noteData = Object.values(dataN);
						const notesList = document.getElementById('notesList');

						notesList.innerHTML = ``;
						noteData.map((note) => {
							if (note.id === playerID) {

								let date = new Date(note.date);
								let formattedDate = date.toLocaleDateString('en-US', {
									month: '2-digit',
									day: '2-digit',
									year: 'numeric',
									hour: '2-digit',
									minute: '2-digit',
								});

								notesList.innerHTML += `<li><div class="dateTime">${formattedDate}</div><div class="note">${note.entry}</div></li>`;
							}
						});
					}

					notesButton.addEventListener('click', () => {
						notesDialog.showModal();
						//notesDialog.setAttribute('data-player-id', data.Player.SteamID);
						getNotes(data.Player.SteamID);
					});



					const PlayersSquadID = data.SquadInfo.ID;

					// get list of squadmembers
					const squadResponse = await fetch(
						`https://api.whalleybot.com/bot/217fc652/GetSquad?SquadID=${PlayersSquadID}`,
						{
							method: 'GET',
							headers: {
								Accept: '*/*',
								Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
							},
						},
					);
					const dataS = await squadResponse.json();
					const SquadData = dataS[0];
					const squadMembers = Object.values(SquadData.squadMember);
					const activeMembers = [];
					squadMembers.forEach((member) => {
						if (member.playerData !== null) {
							activeMembers.push(member.playerData.steamID);
						}
					});

					getFlagData(activeMembers);
					getSquadData(data.SquadInfo.ID);
					getVehicleInfo(squadMembers);
				} catch (error) {
					console.error('Error fetching player info:', error);
					playerInfo.innerHTML = `Error: ${error.message}`;
				}
			} else {
				console.error('Please provide a player ID');
			}

			// reset form
			document.getElementById('playerIDgp').value = '';
		});

		async function getSquadData(PlayersSquadID) {
			const response = await fetch(
				`https://api.whalleybot.com/bot/217fc652/GetSquad?SquadID=${PlayersSquadID}`,
				{
					method: 'GET',
					headers: {
						Accept: '*/*',
						Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
					},
				},
			);

			// Check if the response is okay
			if (!response.ok) {
				throw new Error('Network response was not ok');
			}

			// Parse the response data
			const data = await response.json();
			const SquadData = data[0];

			squadInfo.innerHTML += `<hr class="infoHr"/>`;
			squadInfo.innerHTML += `<br>Squad: ${SquadData.squadName} (${SquadData.id})`;

			const squadMembers = Object.values(SquadData.squadMember);

			//Calculate the total creditBalance and goldBalance of the squad
			let totalCreditBalance = 0;
			let totalGoldBalance = 0;
			let totalCoins = 0;

			squadMembers.forEach((member) => {
				if (member.playerData !== null) {
					totalCreditBalance += member.playerData.creditBalance;
					totalGoldBalance += member.playerData.goldBalance;
					totalCoins += member.playerData.coins;
				}
			});

			squadInfo.innerHTML += `<br>ü™ô ${totalCoins.toLocaleString()} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üíµ  ${totalCreditBalance.toLocaleString()} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üí∞  ${totalGoldBalance.toLocaleString()}<br>`;

			// Rank is a string 1-4 so sort by rank
			squadMembers.sort((a, b) => parseInt(b.rank) - parseInt(a.rank));
			details.innerHTML += `<br>`;
			const numMembers = squadMembers.length;
			memberCount.innerHTML = `ü™ñ Members: ${numMembers} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;`;
			details.innerHTML += `<br> ${numMembers} Members`;
			squadMembers.forEach((member) => {
				if (member.playerData === null) {
					details.innerHTML += `<br><strong>Unknown</strong> (${member.steamID}) `;
					details.innerHTML += `<br>`;
				} else {
					details.innerHTML += `<br><strong>${member.playerData.playerName}</strong> ${member.rank === '4' ? 'üëë' : ''} (${member.steamID}) `;
					details.innerHTML += `<br>ü™ô ${member.playerData.coins.toLocaleString()}  &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üíµ ${member.playerData.creditBalance.toLocaleString()}  &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; üí∞ ${member.playerData.goldBalance.toLocaleString()}  &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; ‚öîÔ∏è ${member.playerData.totalDeaths}/${member.playerData.totalKills}`;
					details.innerHTML += `<br>`;
				}
			});
		}

		function isWithinPVP(flagLocationX, flagLocationY) {
			const PVP = {
				topLeftX: -904795.125, // Left-most X
				topLeftY: 619200.0, // Top-most Y
				bottomRightX: -297316.625, // Right-most X
				bottomRightY: -904795.125, // Bottom-most Y
			};

			// Check if the flag location is within the PVP zone
			return (
				flagLocationX >= PVP.topLeftX && // Right of left edge
				flagLocationX <= PVP.bottomRightX && // Left of right edge
				flagLocationY <= PVP.topLeftY && // Below top edge
				flagLocationY >= PVP.bottomRightY // Above bottom edge
			);
		}

		async function getFlagData(squadMembers) {
			const response = await fetch(
				`https://api.whalleybot.com/bot/217fc652/FlagLocations`,
				{
					method: 'GET',
					headers: {
						Accept: '*/*',
						Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
					},
				},
			);

			// Check if the response is okay
			if (!response.ok) {
				throw new Error('Network response was not ok');
			}

			//const playerInfo = document.getElementById('playerInfo');
			const dataP = await response.json();
			const FlagData = Object.values(dataP);

			// find all flags owened by squadMembers
			const flags = FlagData.filter((flag) =>
				squadMembers.map((member) => member).includes(flag.ownerID),
			);

			flagCount.innerHTML = ` üö© Flags: ${flags.length} &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;`;

			details.innerHTML += `<hr class="infoHr"/>`;
			details.innerHTML += `<br>${flags.length} Flag(s): `;

			flags.forEach((flag) => {
				//details.innerHTML += `<br>${flag.location}`;

				const flagLocation = flag.location;
				const flagLocationX = flagLocation.split(' ')[0]; // -894859.312
				const flagLocationY = flagLocation.split(' ')[1]; // -276433.656

				if (isWithinPVP(flagLocationX, flagLocationY)) {
					details.innerHTML += `<br> üü• ${flagLocation}`; // üü• -894859.312 -276433.656 22457.848
				} else {
					details.innerHTML += `<br> üü© ${flagLocation}`; // üü© -894859.312 -276433.656 22457.848
				}
				details.innerHTML += `<br>`;
			});
		}

		async function getVehicleInfo(squadMembers) {
			try {
				// Fetch the list of vehicles
				const response = await fetch(
					`https://api.whalleybot.com/bot/217fc652/VehicleLocations`,
					{
						method: 'GET',
						headers: {
							Accept: '*/*',
							Authorization: 'WhalleyBotAPI_F935H3ucUJRv7g==',
						},
					},
				);

				if (!response.ok) {
					throw new Error('Failed to fetch vehicle data');
				}

				const dataV = await response.json();
				const vehiclesData = Object.values(dataV);

				// Filter vehicles owned by the player or squad members
				const ownedVehicles = vehiclesData.filter((vehicle) => {
					const regInfo = vehicle.value.reg;
					const ownerSteamID = regInfo.match(/STEAMID:(\d+)/)?.[1];
					if (ownerSteamID && ownerSteamID !== '0') {
						// check if ownerSteamID is one of the squadMembers
						const isSquadMember = squadMembers
							.map((member) => member.steamID)
							.includes(ownerSteamID);
						if (isSquadMember) {
							return vehicle;
						}
					}
				});
				vehicleCount.innerHTML = ` üöó Vehicle: ${ownedVehicles.length}`;
				// Display the vehicle information
				details.innerHTML += `<hr class="infoHr"/>`;
				details.innerHTML += `<br>${ownedVehicles.length} Vehicle(s):`;

				ownedVehicles.forEach((vehicle) => {
					const vidMatch = vehicle.value.reg.match(/VID:(\d+)/);
					const coords = vehicle.value.coords;
					const type = vehicle.value.type.replace('BPC_', '').trim();
					const internalStatus = vehicle.value.internalStatus;
					const status = internalStatus ? internalStatus : 'In Game';

					const vehicleLocationX = coords.split(' ')[0];
					const vehicleLocationY = coords.split(' ')[1];

					let zone = ``;

					if (isWithinPVP(vehicleLocationX, vehicleLocationY)) {
						zone = `üü•`;
					} else {
						zone = `üü©`;
					}

					details.innerHTML +=
						`<br>${type} - ${vidMatch ? vidMatch[1] : 'Unknown'}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;` +
						`${status !== 'In Game' ? ` [${status}]` : ''} ${zone} ${coords}`;

					details.innerHTML += `<br>`;
				});
			} catch (error) {
				console.error('Error fetching or displaying vehicle data:', error);
			}
		}

	});
</script>

<style is:inline>
	.playersList {
		display: flex;
		flex-direction: column;
		gap: 0.5em;
		max-height: 15em;
		overflow-y: auto;
		width: 100%;
	}

	.wrapper hr {
		margin-top: 3em;
		margin-bottom: 1em;
	}

	.wrapper hr.infoHr {
		border: 0.25em solid var(--color-secondary);
		border-radius: 0.5em;
	}

	.playerInfoWrapper.panel {
		border-radius: 0.5em;
		border: 3px solid var(--color-tertiary);
		background: var(--color-tertiary);
		padding: 0.5em 1.5em;
		display: flex;
		flex-direction: column;
		width: 100%;
	}
	.playerInfoWrapper h3 {
		font-size: 1.5em;
		line-height: 2;
	}

	.row {
		display: flex;
		flex-direction: row;
		gap: 1em;
		flex-wrap: wrap;
		align-items: flex-start;
	}

	.playerIDSelect-container {
		flex: 1;
	}
	.playerIDgp-container {
		flex: 1;
	}

	.playerInfoWrapper > * {
		position: relative;
	}
	.dateTime {
		font-size: 0.8em;
		opacity: 0.75;
	}
	.wrapper .notesButton {
		position: absolute;
		top: 0;
		right: -1.5em;
		background: transparent;
		height: 4em;
		display: grid;
		place-items: center;
		margin-bottom: 0;
	}
	.wrapper .notesButton:hover {
		outline: none;
	}

	.notesButton i {
		font-size: 2em;
	}
	.notesButton span {
		background-color: var(--color-accent);
		box-shadow: -1px 1px 13px 3px #00000042;
		padding: 0.5em;
		border-radius: 0.5em;
		opacity: 0;
		font-size: 0.8em;
		margin-top: -10em;
	}
	.notesButton:hover i {
		/* color: var(--color-accent); */
	}
	.notesButton:hover span {
		opacity: 1;
	}
	.notesDialog footer {
		padding: 0 1em 1em;
	}
	.notesDialog footer ul {
		list-style: none;
		padding: 0;
	}
	.notesDialog footer li {
		padding: 1em;
		border-top: 0.25em solid var(--color-tertiary);
	}
	.notesDialog footer li h2 {
		margin: 0;
	}
	.notesDialog footer li h2 span {
		font-size: 0.8em;
	}
	form {
		align-items: self-end;
		display: flex;
		flex-direction: column;
		gap: 1em;
		padding: 0 0 1em 0;
	}
</style>
